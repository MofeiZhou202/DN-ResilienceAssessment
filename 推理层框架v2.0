# 配电网弹性评估系统 - 推理层 v2.0 技术架构文档
**基于混合因果匹配 (Hybrid Causal Matching) 与 鲁棒统计修正的评估框架**

## 1. 核心设计理念 (Design Philosophy)

本模块旨在解决传统机器学习在配电网弹性评估中的**“相关性混淆”**与**“物理约束缺失”**问题。
系统不再单纯依赖“黑盒预测”，而是通过**混合策略 (Hybrid Strategy)**，将**历史真实数据的因果匹配**与**统计模型的非线性拟合**相结合，以提供最保守、最符合物理规律的决策支持。

---

## 2. 混合评估引擎逻辑 (Hybrid Inference Engine)

系统根据评估指标的物理特性，自动分流采用不同的推理算法：

### 2.1 策略 A：因果匹配引擎 (KNN Causal Matching)
> **适用指标**：系统总失负荷量 (Total Load Loss, kW·h)
> **核心逻辑**：寻找“平行宇宙”中的真实物理证据。

*   **算法原理**：
    当评估“修复线路 $L_i$”的收益时，不使用模型预测，而是利用 **K-近邻算法 (KNN)** 在历史数据库中搜索。
*   **匹配标准**：
    使用 **汉明距离 (Hamming Distance)** 计算拓扑相似度。寻找满足以下条件的场景：
    1.  **其他线路状态高度相似**（即台风破坏模式一致）。
    2.  **唯独 $L_i$ 是正常运行的**。
*   **收益计算**：
    $$ \Delta \text{Loss} = \text{Loss}_{\text{当前场景}} - \text{Loss}_{\text{历史匹配场景}} $$
*   **解决痛点**：
    彻底消除了**“共模故障干扰”**（Correlated Fault Confounding）。避免了模型误认为“因为台风天 $L_i$ 断了，$L_j$ 肯定也断了，所以修好 $L_i$ 没用”的错误逻辑。

### 2.2 策略 B：统计代理引擎 (XGBoost Surrogate)
> **适用指标**：节点复电达标率 (Restoration Probability, $T < 2h$)
> **核心逻辑**：利用梯度提升树捕捉非线性阈值效应。

*   **算法原理**：
    复电时间是离散的概率问题，且存在明显的“阈值效应”（差 1 分钟也是不达标）。
*   **应用方式**：
    利用训练好的 XGBoost 模型构建**系统级反事实 (System-level Counterfactual)**。
    计算在 $L_i$ 修复后，全系统满足 $T < 2h$ 的节点比例提升的期望值。
*   **解决痛点**：
    KNN 在处理稀疏的二分类（0/1）数据时效果不佳，而 XGBoost 擅长捕捉这种复杂的非线性边界。

---

## 3. 鲁棒性修正机制 (Robustness Mechanisms)

为了确保输出结果的严谨性，防止 AI “报喜不报忧”，引入了以下三层修正：

### 3.1 双重保守估计 (Dual-level Conservative Estimation)
在计算 KNN 匹配收益时，同时执行两个维度的匹配，并取**最小值**作为最终结论：
1.  **场景级匹配 (Scenario-level)**：匹配整个故障事件的相似度。
2.  **小时级匹配 (Hourly-level)**：匹配特定时间断面的负荷与拓扑状态。
*   **公式**：$\text{Benefit} = \min(\text{Benefit}_{\text{scenario}}, \text{Benefit}_{\text{hourly}})$

### 3.2 全局基准加权 (Global Baseline Weighting)
*   **旧逻辑**：计算单一样本的改善率 $\to$ 容易出现分母过小导致的数值爆炸。
*   **新逻辑**：
    $$ \text{Improvement \%} = \frac{\sum \text{Expected Benefit}}{\text{Global Expected Loss (Julia Baseline)}} $$
    使用 Julia 仿真计算出的全局期望损失（如 11221.78 kW·h）作为统一分母，确保评估尺度的一致性。

### 3.3 聚合截断策略 (Aggregate Truncation)
*   **操作**：不在每个微小样本上做 `max(0)` 截断，而是在计算出总期望后进行截断。
*   **目的**：允许统计噪声中的负值与正值相互抵消，避免因过早截断负噪声而导致整体评估结果**虚高 (Upward Bias)**。

---

## 4. 数据流处理规范 (Data Pipeline)

为确保推理的物理一致性，执行严格的数据对齐：

1.  **源数据一致性 (Source Consistency)**：
    强制 `find_latest_results()` 函数必须从同一目录读取 `topology_status` 和 `dispatch_results`，防止拓扑与负荷数据的时间戳错位。
2.  **特征隔离**：
    在 KNN 匹配时，严格剔除环境参数，仅基于**线路开关状态 (0/1)** 计算距离，确保归因纯粹指向物理架构。

---

## 5. 总结：该架构的科研价值 (Research Value)

该方案成功实现了从**“相关性学习”**向**“因果推断”**的跨越：

1.  **物理可信度 (Physics-Informed)**：通过直接复用历史仿真结果（KNN），保证了输出的失负荷量绝对符合基尔霍夫定律，彻底消除了代理模型的“物理幻觉”。
2.  **归因准确性 (Causal Accuracy)**：通过控制变量的最近邻匹配，精准剥离了台风天气对多重故障的混淆影响，实现了对单条线路价值的净值评估。
3.  **工程落地性 (Engineering Robustness)**：保守估计策略确保了给出的加固建议在最坏情况下依然有效，符合电力系统“安全第一”的原则。
